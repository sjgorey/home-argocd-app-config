apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: stock-alerts-email
  namespace: finance-exporter
  labels:
    app.kubernetes.io/name: finance-exporter
    app.kubernetes.io/component: alerting
    app.kubernetes.io/part-of: home-infrastructure
    alertmanagerConfig: kube-prometheus-stack
spec:
  route:
    groupBy: ['team']
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 4h
    receiver: 'stock-alerts-email'
    matchers:
    - name: team
      value: finance
  receivers:
  - name: 'stock-alerts-email'
    emailConfigs:
    - to: 'steve.gorey+stockalerts@gmail.com'
      from: 'gorco@maine.rr.com'
      smarthost: 'smtp-relay.smtp-relay.svc.cluster.local:25'
      html: |
        {{ if eq .Status "firing" }}
        <h2>ðŸš¨ STOCK ALERT TRIGGERED</h2>
        {{ else }}
        <h2>âœ… STOCK ALERT RESOLVED</h2>
        {{ end }}
        
        <h3>Alert Details:</h3>
        <ul>
        <li><strong>Stock:</strong> {{ .GroupLabels.stock }}</li>
        <li><strong>Alert:</strong> {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}</li>
        <li><strong>Status:</strong> {{ .Status | title }}</li>
        <li><strong>Time:</strong> {{ range .Alerts }}{{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}{{ end }}</li>
        </ul>
        
        {{ if eq .Status "firing" }}
        <h3>Current Information:</h3>
        <ul>
        {{ range .Alerts }}
        <li><strong>Current Price:</strong> ${{ .Annotations.current_price }}</li>
        <li><strong>Threshold:</strong> ${{ .Annotations.threshold }}</li>
        <li><strong>Description:</strong> {{ .Annotations.description }}</li>
        {{ end }}
        </ul>
        
        <h3>Action Required:</h3>
        <p>Review your investment position and consider appropriate action.</p>
        {{ else }}
        <h3>Resolution:</h3>
        <p>The stock price has returned above the threshold level.</p>
        
        <h3>Next Steps:</h3>
        <p>Monitor for continued stability or adjust alert thresholds if needed.</p>
        {{ end }}
        
        <h3>Trading Platform Links:</h3>
        <ul>
        <li><a href="https://finance.yahoo.com/quote/WEX">Yahoo Finance WEX</a></li>
        </ul>
        
        <hr>
        <p><em>Sent from K3s Cluster Finance Monitoring System</em></p>
      subject: '{{ if eq .Status "firing" }}ðŸš¨ STOCK ALERT: {{ .GroupLabels.stock }}{{ else }}âœ… RESOLVED: {{ .GroupLabels.stock }}{{ end }}'